<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropMyElectronic | Schedule Pickup</title>
    <meta name="description" content="Schedule e-waste pickup. Auto-matching with best recycler near you.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;transition:all .3s ease}
        :root{--primary:#2e7d32;--secondary:#ff9800;--text:#333;--bg:#f5f5f5;--card:#fff;--shadow:0 4px 6px rgba(0,0,0,0.1)}
        .dark-mode{--primary:#4caf50;--secondary:#ffb74d;--text:#e0e0e0;--bg:#121212;--card:#2d2d2d;--shadow:0 4px 6px rgba(0,0,0,0.3)}
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea15,#764ba215);color:var(--text);min-height:100vh}
        .container{width:90%;max-width:800px;margin:0 auto;padding:20px}
        .header{display:flex;justify-content:space-between;align-items:center;padding:20px 0}
        .logo{font-size:1.8rem;font-weight:700;color:var(--primary);text-decoration:none}
        .back-btn{color:var(--text);text-decoration:none;display:flex;align-items:center;gap:8px;margin-bottom:10px}
        .card{background:var(--card);border-radius:20px;padding:40px;box-shadow:var(--shadow);margin:20px 0}
        .badge{background:linear-gradient(135deg,var(--primary),#1b5e20);color:#fff;padding:6px 16px;border-radius:30px;font-size:.85rem;display:inline-block;margin-bottom:20px;font-weight:600}
        h1{font-size:2rem;margin-bottom:10px}
        .form-group{margin-bottom:25px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        label{display:block;margin-bottom:8px;font-weight:600}
        select,input,textarea{width:100%;padding:14px 16px;border:2px solid #e0e0e0;border-radius:12px;font-size:1rem;background:var(--card);color:var(--text)}
        select:focus,input:focus,textarea:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(46,125,50,0.1)}
        .location-status{background:#f0f9ff;border:2px solid #bae6fd;border-radius:12px;padding:16px;display:flex;align-items:center;gap:12px}
        .location-dot{width:12px;height:12px;background:#22c55e;border-radius:50%;animation:pulse 2s infinite}
        @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(34,197,94,0.4)}70%{box-shadow:0 0 0 10px rgba(34,197,94,0)}}
        .btn{background:var(--primary);color:#fff;padding:12px 24px;border-radius:12px;font-weight:600;border:none;cursor:pointer;font-size:1rem}
        .btn:hover{background:#1b5e20;transform:translateY(-2px)}
        .btn-secondary{background:var(--secondary)}
        .btn-large{width:100%;padding:16px!important;font-size:1.1rem!important}
        .btn-small{padding:8px 16px!important;font-size:.9rem!important}
        .hidden{display:none!important}
        .spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 1s infinite;margin-right:10px}
        .spinner-dark{border-top-color:#666}
        @keyframes spin{to{transform:rotate(360deg)}}
        .manual-section{margin-top:20px;padding:20px;background:rgba(255,152,0,0.05);border-radius:12px;border:1px dashed var(--secondary)}
        .recycler-card{background:linear-gradient(135deg,#f8f9fa,#e9ecef);border-radius:16px;padding:24px;margin:30px 0;border-left:6px solid var(--primary)}
        .dark-mode .recycler-card{background:linear-gradient(135deg,#2d2d2d,#1e1e1e)}
        .recycler-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .recycler-name{font-size:1.3rem;font-weight:700}
        .recycler-badge{background:var(--primary);color:#fff;padding:6px 12px;border-radius:30px;font-size:.8rem}
        .recycler-details{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:20px}
        .detail-item{background:#fff;padding:12px;border-radius:12px;text-align:center}
        .dark-mode .detail-item{background:#2d2d2d;border:1px solid #404040}
        .detail-label{font-size:.75rem;color:#6b7280;text-transform:uppercase;margin-bottom:5px}
        .detail-value{font-size:1.2rem;font-weight:700}
        .results-actions{display:flex;gap:15px;margin-top:30px}
        .checkmark{font-size:64px;margin-bottom:20px}
        .confirmation-details{background:#f0fdf4;padding:20px;border-radius:16px;margin:20px 0;color:#166534}
        .dark-mode .confirmation-details{background:#1e3a1e;color:#86efac}
        .dark-mode-switch{position:relative;width:34px;height:18px;background:#ccc;border-radius:34px}
        .dark-mode-switch::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:#fff;border-radius:50%;transition:.3s}
        #dark-mode-checkbox:checked+.dark-mode-switch::after{transform:translateX(16px)}
        #dark-mode-checkbox{display:none}
        .location-error{background:#fee2e2!important;border-color:#fecaca!important}
        .location-warning{background:#fff3cd!important;border-color:#ffeeba!important}
        .cached-badge{font-size:.7rem;background:#6b7280;color:#fff;padding:2px 6px;border-radius:4px;margin-left:8px}
        @media (max-width:768px){.form-row,.recycler-details,.results-actions{grid-template-columns:1fr;flex-direction:column}.card{padding:25px}h1{font-size:1.8rem}}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <a href="index.html" class="logo">DropMyElectronic</a>
        <div class="dark-mode-toggle">
            <label for="dark-mode-checkbox" class="dark-mode-label">
                <i class="fas fa-moon"></i><span>Dark Mode</span>
                <input type="checkbox" id="dark-mode-checkbox">
                <div class="dark-mode-switch" role="switch"></div>
            </label>
        </div>
    </div>
    
    <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back</a>
    
    <!-- Step 1: Form -->
    <div id="step1" class="card">
        <div class="badge">‚úÖ Auto-Routing by Location</div>
        <h1>Schedule E-Waste Pickup</h1>
        <p style="color:#6b7280;margin-bottom:30px;">Auto-matching with best recycler near you.</p>
        
        <form id="pickupForm">
            <div class="form-row">
                <div class="form-group">
                    <label>üì± Device</label>
                    <select id="itemType" required>
                        <option value="">Select</option>
                        <option value="laptop">üíª Laptop - KSh 150</option>
                        <option value="smartphone">üì± Phone - KSh 80</option>
                        <option value="tablet">üìü Tablet - KSh 120</option>
                        <option value="monitor">üñ•Ô∏è Monitor - KSh 200</option>
                        <option value="printer">üñ®Ô∏è Printer - KSh 180</option>
                        <option value="tv">üì∫ TV - KSh 250</option>
                        <option value="battery">üîã Battery - KSh 50</option>
                        <option value="other">üîß Other - KSh 100</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>üî¢ Qty</label>
                    <input type="number" id="quantity" min="1" value="1" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>üìç Auto Location</label>
                <div id="locationDisplay" class="location-status">
                    <span class="location-dot"></span>
                    <span id="locationText">Detecting...</span>
                </div>
                <button type="button" id="retryLocation" class="btn btn-small" style="margin-top:10px;background:var(--secondary);">üîÑ Retry Detection</button>
            </div>
            
            <div class="manual-section">
                <h4 style="display:flex;gap:8px;color:var(--secondary);margin-bottom:15px;">
                    <i class="fas fa-pencil-alt"></i> Manual Entry (Override)
                </h4>
                <div class="form-row">
                    <div class="form-group">
                        <label>üìÆ Postal Code</label>
                        <input type="text" id="postalCode" placeholder="e.g., 100" value="100">
                    </div>
                    <div class="form-group">
                        <label>üèôÔ∏è City</label>
                        <input type="text" id="city" placeholder="e.g., Nairobi" value="Nairobi">
                    </div>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üìÖ Date</label>
                    <input type="date" id="pickupDate" required>
                </div>
                <div class="form-group">
                    <label>‚è∞ Time</label>
                    <select id="pickupTime" required>
                        <option value="">Select</option>
                        <option value="morning">Morning (9AM-12PM)</option>
                        <option value="afternoon">Afternoon (12PM-5PM)</option>
                        <option value="evening">Evening (5PM-8PM)</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>üìù Notes</label>
                <textarea id="notes" rows="2" placeholder="Special instructions"></textarea>
            </div>
            
            <button type="submit" id="submitBtn" class="btn btn-large" style="background:var(--secondary);">
                <span id="btnText">üîç Find Best Recycler</span>
                <span id="btnLoading" class="hidden"><span class="spinner"></span> Finding...</span>
            </button>
        </form>
    </div>
    
    <!-- Step 2: Results -->
    <div id="step2" class="card hidden">
        <div class="confirmation">
            <div class="checkmark">‚úÖ</div>
            <h2>Recycler Found!</h2>
            <p style="color:#6b7280;margin-bottom:20px;">Auto-matched to best recycler</p>
            <div id="assignedRecycler" class="recycler-card"></div>
            <div class="results-actions">
                <button onclick="confirmPickup()" class="btn btn-large" style="background:var(--primary);">‚úÖ Confirm</button>
                <button onclick="resetForm()" class="btn btn-large" style="background:#6b7280;">‚Ü©Ô∏è Edit</button>
            </div>
        </div>
    </div>
    
    <!-- Step 3: Confirmation -->
    <div id="step3" class="card hidden">
        <div class="confirmation">
            <div class="checkmark">üéâ</div>
            <h2>Confirmed!</h2>
            <p style="color:#6b7280;margin-bottom:20px;">Pickup scheduled</p>
            <div class="confirmation-details">
                <p id="confirmationNumber" style="font-size:1.2em;font-weight:600;"></p>
                <p style="margin-top:10px;">SMS/email updates sent</p>
            </div>
            <div class="results-actions">
                <a href="index.html" class="btn btn-large" style="background:var(--primary);">üè† Home</a>
                <button onclick="scheduleAnother()" class="btn btn-large" style="background:var(--secondary);">üìÖ New Pickup</button>
            </div>
        </div>
    </div>
</div>

<script>
// Dark Mode
(() => {
    const t = document.getElementById('dark-mode-checkbox'), b = document.body;
    (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) && (b.classList.add('dark-mode'), t.checked = true, document.querySelector('.dark-mode-label i').className = 'fas fa-sun', document.querySelector('.dark-mode-label span').textContent = 'Light Mode');
    t.addEventListener('change', () => {
        b.classList.toggle('dark-mode');
        const isDark = b.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.querySelector('.dark-mode-label i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        document.querySelector('.dark-mode-label span').textContent = isDark ? 'Light Mode' : 'Dark Mode';
    });
})();

// Data
const recyclers = [
    {id:1,name:"EcoRecycle Kenya",rating:4.8,distance:2.3,price:{laptop:150,smartphone:80,tablet:120,monitor:200,printer:180,tv:250,battery:50,other:100},coverage:["100","200","300"],workload:3,specialization:["laptop","smartphone","tablet","battery"],responseTime:"2-4h"},
    {id:2,name:"GreenCycle EA",rating:4.6,distance:5.1,price:{laptop:140,smartphone:70,tablet:110,monitor:180,printer:160,tv:220,battery:45,other:90},coverage:["400","500","600"],workload:1,specialization:["monitor","printer","tv"],responseTime:"4-6h"},
    {id:3,name:"Circuit Reclaim",rating:4.9,distance:3.7,price:{laptop:160,smartphone:90,tablet:130,monitor:220,printer:200,tv:280,battery:55,other:120},coverage:["700","800","900"],workload:2,specialization:["laptop","monitor","tv"],responseTime:"1-3h"},
    {id:4,name:"Battery & Beyond",rating:4.7,distance:1.8,price:{laptop:130,smartphone:60,tablet:100,monitor:190,printer:170,tv:240,battery:40,other:80},coverage:["100","200","300"],workload:5,specialization:["smartphone","tablet","battery","other"],responseTime:"3-5h"}
];

let userLocation = {detected:!1, postalCode:"100", city:"Nairobi", source:"default"};

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    const d = document.getElementById('pickupDate');
    d.min = d.value = new Date().toISOString().split('T')[0];
    document.getElementById('pickupForm').addEventListener('submit', handleSubmit);
    document.getElementById('retryLocation').addEventListener('click', detectLocation);
    ['postalCode','city'].forEach(id => document.getElementById(id).addEventListener('input', function() { 
        userLocation[this.id] = this.value || (this.id === 'postalCode' ? '100' : 'Nairobi'); 
        userLocation.source = 'manual'; userLocation.detected = !1; 
    }));
    loadCachedLocation();
    setTimeout(detectLocation, 500);
});

function loadCachedLocation() {
    try {
        const c = JSON.parse(localStorage.getItem('lastLocation'));
        if (c && Date.now() - c.timestamp < 3600000) {
            userLocation = {...userLocation, postalCode: c.postalCode, city: c.city, source: 'cached'};
            document.getElementById('postalCode').value = c.postalCode;
            document.getElementById('city').value = c.city;
            document.getElementById('locationText').innerHTML = `üìç ${c.city} (${c.postalCode}) - Cached <span class="cached-badge">1h</span>`;
            document.getElementById('locationDisplay').style.background = '#e6f7ff';
        }
    } catch(e){}
}

function detectLocation() {
    const locText = document.getElementById('locationText'), locDisplay = document.getElementById('locationDisplay'), postal = document.getElementById('postalCode'), city = document.getElementById('city');
    if (!navigator.geolocation) return locText.innerHTML = "‚ùå Not supported - using manual", locDisplay.classList.add('location-error');
    
    locText.innerHTML = '<span class="spinner spinner-dark" style="border-top-color:#666;"></span> Detecting...';
    locDisplay.classList.remove('location-error', 'location-warning');
    
    navigator.geolocation.getCurrentPosition(
        async pos => {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}&addressdetails=1`, 
                    {headers: {'Accept-Language': 'en-US', 'User-Agent': 'DropMyElectronic/1.0'}});
                const data = await res.json();
                if (data?.address) {
                    const cityName = data.address.city || data.address.town || data.address.village || data.address.suburb || 'Unknown';
                    let pCode = (data.address.postcode || '').replace(/\D/g, '') || getDefaultPostalCode(cityName);
                    userLocation = {detected:!0, postalCode:pCode, city:cityName, source:'gps'};
                    localStorage.setItem('lastLocation', JSON.stringify({postalCode:pCode, city:cityName, timestamp:Date.now()}));
                    locText.innerHTML = `üìç ${cityName} (${pCode}) - Auto-detected`;
                    locDisplay.style.background = '#f0f9ff';
                    postal.value = pCode; city.value = cityName;
                } else throw new Error();
            } catch {
                const approx = getApproxLocation(pos.coords.latitude, pos.coords.longitude);
                userLocation = {detected:!0, postalCode:approx.pCode, city:approx.city, source:'approximate'};
                locText.innerHTML = `üìç Approx: ${approx.city} (${approx.pCode}) - Limited accuracy`;
                locDisplay.classList.add('location-warning');
                postal.value = approx.pCode; city.value = approx.city;
            }
        },
        err => {
            const msg = ["‚ùå Permission denied","‚ùå Position unavailable","‚ùå Timeout"][err.code-1] || "‚ùå Failed";
            locText.innerHTML = msg + " - using manual";
            locDisplay.classList.add('location-error');
            userLocation.source = 'manual';
        },
        {enableHighAccuracy:!0, timeout:1e4}
    );
}

function getDefaultPostalCode(city) {
    const codes = {Nairobi:'100',Mombasa:'200',Kisumu:'300',Nakuru:'400',Eldoret:'500',Thika:'600',Kiambu:'700',Machakos:'800',Meru:'900'};
    for (let [k,v] of Object.entries(codes)) if (city.toLowerCase().includes(k.toLowerCase())) return v;
    return '100';
}

function getApproxLocation(lat, lon) {
    if (lat > -1.4 && lat < -1.1 && lon > 36.7 && lon < 37.0) return {city:'Nairobi',pCode:'100'};
    if (lat > -4.1 && lat < -3.9 && lon > 39.6 && lon < 39.7) return {city:'Mombasa',pCode:'200'};
    if (lat > -0.2 && lat < 0 && lon > 34.7 && lon < 34.8) return {city:'Kisumu',pCode:'300'};
    if (lat > -0.4 && lat < -0.2 && lon > 36.0 && lon < 36.2) return {city:'Nakuru',pCode:'400'};
    return {city:'Nairobi',pCode:'100'};
}

function findBestRecycler(type, qty) {
    const eligible = recyclers.filter(r => r.specialization.includes(type) || r.specialization.includes('other'));
    if (!eligible.length) return null;
    return eligible.map(r => ({
        ...r,
        score: Math.max(0,40-r.distance*2) + (r.coverage.includes(userLocation.postalCode)?30:r.distance<10?20:10) + Math.max(0,20-r.workload*3) + (r.specialization.includes(type)?10:5) + (r.rating-4)*5,
        totalPrice: (r.price[type]||r.price.other)*qty
    })).sort((a,b)=>b.score-a.score)[0];
}

function handleSubmit(e) {
    e.preventDefault();
    const type = document.getElementById('itemType').value, qty = document.getElementById('quantity').value;
    if (!type) return alert('Select device');
    
    userLocation.postalCode = document.getElementById('postalCode').value || '100';
    userLocation.city = document.getElementById('city').value || 'Nairobi';
    
    document.getElementById('btnText').classList.add('hidden');
    document.getElementById('btnLoading').classList.remove('hidden');
    document.getElementById('submitBtn').disabled = !0;
    
    setTimeout(() => {
        const r = findBestRecycler(type, parseInt(qty));
        document.getElementById('btnText').classList.remove('hidden');
        document.getElementById('btnLoading').classList.add('hidden');
        document.getElementById('submitBtn').disabled = !1;
        
        if (r) {
            const names = {laptop:'üíª Laptop',smartphone:'üì± Phone',tablet:'üìü Tablet',monitor:'üñ•Ô∏è Monitor',printer:'üñ®Ô∏è Printer',tv:'üì∫ TV',battery:'üîã Battery',other:'üîß Other'};
            const src = {gps:'üìç GPS',cached:'üíæ Cached',approximate:'üì° Approx',manual:'‚úèÔ∏è Manual'}[userLocation.source] || 'üìç';
            document.getElementById('assignedRecycler').innerHTML = `
                <div class="recycler-header"><span class="recycler-name">üè≠ ${r.name}</span><span class="recycler-badge">‚≠ê ${r.rating}</span></div>
                <p style="color:#4b5563;margin-bottom:15px;">‚úì Assigned: ${userLocation.city}, ${userLocation.postalCode} <span style="font-size:0.8em;color:#6b7280;">${src}</span></p>
                <div class="recycler-details">
                    <div class="detail-item"><div class="detail-label">Distance</div><div class="detail-value">${r.distance} km</div></div>
                    <div class="detail-item"><div class="detail-label">Response</div><div class="detail-value">${r.responseTime}</div></div>
                    <div class="detail-item"><div class="detail-label">Price</div><div class="detail-value">KSh ${r.totalPrice}</div></div>
                </div>
                <div style="margin-top:15px;padding-top:15px;border-top:1px solid #e5e7eb;"><p style="font-size:0.9em;color:#059669;"><strong>üèÜ Score:</strong> ${Math.round(r.score)}% ‚Ä¢ Top match</p></div>`;
            
            sessionStorage.setItem('currentPickup', JSON.stringify({r,itemType:names[type],qty,date:document.getElementById('pickupDate').value,time:document.getElementById('pickupTime').value,notes:document.getElementById('notes').value,location:userLocation}));
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        } else alert('No recycler available');
    }, 1500);
}

function confirmPickup() {
    document.getElementById('confirmationNumber').innerHTML = `üìã #DME-${new Date().getFullYear()}-${Math.floor(Math.random()*1e4).toString().padStart(4,'0')}`;
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step3').classList.remove('hidden');
}

function resetForm() {
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step1').classList.remove('hidden');
}

function scheduleAnother() {
    document.getElementById('step3').classList.add('hidden');
    document.getElementById('step1').classList.remove('hidden');
    sessionStorage.removeItem('currentPickup');
    document.getElementById('pickupForm').reset();
    document.getElementById('pickupDate').value = new Date().toISOString().split('T')[0];
    loadCachedLocation();
    detectLocation();
}
</script>
</body>
</html>