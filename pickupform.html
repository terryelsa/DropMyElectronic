<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DropMyElectronic | Schedule Pickup</title>
    <meta name="description" content="Schedule e-waste pickup. Auto-matching with best recycler near you.">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        *{margin:0;padding:0;box-sizing:border-box;transition:all .3s ease}
        :root{--primary:#2e7d32;--secondary:#ff9800;--text:#333;--bg:#f5f5f5;--card:#fff;--shadow:0 4px 6px rgba(0,0,0,0.1)}
        .dark-mode{--primary:#4caf50;--secondary:#ffb74d;--text:#e0e0e0;--bg:#121212;--card:#2d2d2d;--shadow:0 4px 6px rgba(0,0,0,0.3)}
        body{font-family:'Segoe UI',sans-serif;background:linear-gradient(135deg,#667eea15,#764ba215);color:var(--text);min-height:100vh}
        .container{width:90%;max-width:800px;margin:0 auto;padding:20px}
        .header{display:flex;justify-content:space-between;align-items:center;padding:20px 0}
        .logo{font-size:1.8rem;font-weight:700;color:var(--primary);text-decoration:none}
        .back-btn{color:var(--text);text-decoration:none;display:flex;align-items:center;gap:8px;margin-bottom:10px}
        .card{background:var(--card);border-radius:20px;padding:40px;box-shadow:var(--shadow);margin:20px 0}
        .badge{background:linear-gradient(135deg,var(--primary),#1b5e20);color:#fff;padding:6px 16px;border-radius:30px;font-size:.85rem;display:inline-block;margin-bottom:20px;font-weight:600}
        h1{font-size:2rem;margin-bottom:10px}
        .form-group{margin-bottom:25px}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:20px}
        label{display:block;margin-bottom:8px;font-weight:600}
        select,input,textarea{width:100%;padding:14px 16px;border:2px solid #e0e0e0;border-radius:12px;font-size:1rem;background:var(--card);color:var(--text)}
        select:focus,input:focus,textarea:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(46,125,50,0.1)}
        .location-box{background:var(--bg);border-radius:12px;padding:20px;margin:20px 0;border:2px solid var(--primary);position:relative}
        .location-icon{position:absolute;right:20px;top:50%;transform:translateY(-50%);color:var(--primary);font-size:1.5rem}
        .btn{background:var(--primary);color:#fff;padding:12px 24px;border-radius:12px;font-weight:600;border:none;cursor:pointer;font-size:1rem}
        .btn:hover{background:#1b5e20;transform:translateY(-2px)}
        .btn-secondary{background:var(--secondary)}
        .btn-large{width:100%;padding:16px!important;font-size:1.1rem!important}
        .hidden{display:none!important}
        .spinner{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 1s infinite;margin-right:10px}
        @keyframes spin{to{transform:rotate(360deg)}}
        .recycler-card{background:linear-gradient(135deg,#f8f9fa,#e9ecef);border-radius:16px;padding:24px;margin:30px 0;border-left:6px solid var(--primary)}
        .dark-mode .recycler-card{background:linear-gradient(135deg,#2d2d2d,#1e1e1e)}
        .recycler-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .recycler-name{font-size:1.3rem;font-weight:700}
        .recycler-badge{background:var(--primary);color:#fff;padding:6px 12px;border-radius:30px;font-size:.8rem}
        .recycler-details{display:grid;grid-template-columns:repeat(3,1fr);gap:15px;margin-top:20px}
        .detail-item{background:#fff;padding:12px;border-radius:12px;text-align:center}
        .dark-mode .detail-item{background:#2d2d2d;border:1px solid #404040}
        .detail-label{font-size:.75rem;color:#6b7280;text-transform:uppercase;margin-bottom:5px}
        .detail-value{font-size:1.2rem;font-weight:700}
        .results-actions{display:flex;gap:15px;margin-top:30px}
        .checkmark{font-size:64px;margin-bottom:20px}
        .confirmation-details{background:#f0fdf4;padding:20px;border-radius:16px;margin:20px 0;color:#166534}
        .dark-mode .confirmation-details{background:#1e3a1e;color:#86efac}
        .dark-mode-switch{position:relative;width:34px;height:18px;background:#ccc;border-radius:34px}
        .dark-mode-switch::after{content:'';position:absolute;top:2px;left:2px;width:14px;height:14px;background:#fff;border-radius:50%;transition:.3s}
        #dark-mode-checkbox:checked+.dark-mode-switch::after{transform:translateX(16px)}
        #dark-mode-checkbox{display:none}
        .location-hint{font-size:.85rem;color:#6b7280;margin-top:5px;display:flex;align-items:center;gap:5px}
        .device-section{border:2px solid var(--primary);border-radius:16px;padding:20px;margin-bottom:20px}
        .device-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
        .device-title{font-size:1.1rem;font-weight:600;color:var(--primary)}
        .add-device-btn{background:var(--secondary);color:#fff;border:none;width:36px;height:36px;border-radius:50%;font-size:1.5rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .add-device-btn:hover{background:#f57c00;transform:scale(1.1)}
        .device-row{display:grid;grid-template-columns:2fr 1fr 40px;gap:10px;margin-bottom:15px;align-items:center}
        .remove-device{background:#ef4444;color:#fff;border:none;width:36px;height:36px;border-radius:50%;font-size:1.2rem;cursor:pointer;display:flex;align-items:center;justify-content:center}
        .remove-device:hover{background:#dc2626;transform:scale(1.1)}
        .remove-device:disabled{background:#9ca3af;cursor:not-allowed;transform:none}
        .total-price{background:var(--bg);padding:15px;border-radius:12px;text-align:right;font-size:1.2rem;font-weight:600;margin-top:15px}
        .total-price span{color:var(--primary);font-size:1.4rem;margin-left:10px}
        .device-summary{font-size:.9rem;color:#6b7280;margin-top:5px}
        @media (max-width:768px){.form-row,.recycler-details,.results-actions{grid-template-columns:1fr;flex-direction:column}.card{padding:25px}h1{font-size:1.8rem}.device-row{grid-template-columns:1fr}}
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <a href="index.html" class="logo">DropMyElectronic</a>
        <div class="dark-mode-toggle">
            <label for="dark-mode-checkbox" class="dark-mode-label">
                <i class="fas fa-moon"></i><span>Dark Mode</span>
                <input type="checkbox" id="dark-mode-checkbox">
                <div class="dark-mode-switch" role="switch"></div>
            </label>
        </div>
    </div>
    
    <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back</a>
    
    <!-- Step 1: Form -->
    <div id="step1" class="card">
        <div class="badge">üì¶ Multi-Device Pickup</div>
        <h1>Schedule E-Waste Pickup</h1>
        <p style="color:#6b7280;margin-bottom:30px;">Add one or more devices for pickup.</p>
        
        <form id="pickupForm">
            <div class="device-section">
                <div class="device-header">
                    <span class="device-title"><i class="fas fa-device"></i> Devices</span>
                    <button type="button" id="addDeviceBtn" class="add-device-btn">+</button>
                </div>
                <div id="devicesContainer"></div>
                <div class="total-price">Total: <span id="totalAmount">KSh 0</span></div>
                <div class="device-summary"><i class="fas fa-info-circle"></i> <span id="deviceCountText">0 devices</span></div>
            </div>
            
            <div class="form-group">
                <label>üìç Location</label>
                <div class="location-box">
                    <input type="text" id="location" placeholder="e.g., Nairobi, Westlands" value="Nairobi" required>
                    <i class="fas fa-map-marker-alt location-icon"></i>
                </div>
                <div class="location-hint"><i class="fas fa-info-circle"></i><span>Enter city/area</span></div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>üìÖ Date</label>
                    <input type="date" id="pickupDate" required>
                </div>
                <div class="form-group">
                    <label>‚è∞ Time</label>
                    <select id="pickupTime" required>
                        <option value="">Select</option>
                        <option value="morning">Morning (9AM-12PM)</option>
                        <option value="afternoon">Afternoon (12PM-5PM)</option>
                        <option value="evening">Evening (5PM-8PM)</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>üìù Notes</label>
                <textarea id="notes" rows="2" placeholder="Special instructions"></textarea>
            </div>
            
            <button type="submit" id="submitBtn" class="btn btn-large" style="background:var(--secondary);">
                <span id="btnText">üîç Find Best Recycler</span>
                <span id="btnLoading" class="hidden"><span class="spinner"></span> Finding...</span>
            </button>
        </form>
    </div>
    
    <!-- Step 2: Results -->
    <div id="step2" class="card hidden">
        <div class="confirmation">
            <div class="checkmark">‚úÖ</div>
            <h2>Recycler Found!</h2>
            <p style="color:#6b7280;margin-bottom:20px;">Best match for your devices</p>
            <div id="assignedRecycler" class="recycler-card"></div>
            <div class="results-actions">
                <button onclick="confirmPickup()" class="btn btn-large" style="background:var(--primary);">‚úÖ Confirm</button>
                <button onclick="resetForm()" class="btn btn-large" style="background:#6b7280;">‚Ü©Ô∏è Edit</button>
            </div>
        </div>
    </div>
    
    <!-- Step 3: Confirmation -->
    <div id="step3" class="card hidden">
        <div class="confirmation">
            <div class="checkmark">üéâ</div>
            <h2>Confirmed!</h2>
            <p style="color:#6b7280;margin-bottom:20px;">Pickup scheduled</p>
            <div class="confirmation-details">
                <p id="confirmationNumber" style="font-size:1.2em;font-weight:600;"></p>
                <p id="confirmedDevices" style="margin-top:10px;"></p>
            </div>
            <div class="results-actions">
                <a href="index.html" class="btn btn-large" style="background:var(--primary);">üè† Home</a>
                <button onclick="scheduleAnother()" class="btn btn-large" style="background:var(--secondary);">üìÖ New</button>
            </div>
        </div>
    </div>
</div>

<script>
// Dark Mode
(() => {
    const t = document.getElementById('dark-mode-checkbox'), b = document.body;
    (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) && (b.classList.add('dark-mode'), t.checked = true, document.querySelector('.dark-mode-label i').className = 'fas fa-sun', document.querySelector('.dark-mode-label span').textContent = 'Light Mode');
    t.addEventListener('change', () => {
        b.classList.toggle('dark-mode');
        const isDark = b.classList.contains('dark-mode');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
        document.querySelector('.dark-mode-label i').className = isDark ? 'fas fa-sun' : 'fas fa-moon';
        document.querySelector('.dark-mode-label span').textContent = isDark ? 'Light Mode' : 'Dark Mode';
    });
})();

// Data
const R = [
    {id:1,n:"EcoRecycle Kenya",r:4.8,d:2.3,p:{laptop:150,s:80,t:120,m:200,pr:180,tv:250,b:50,o:100},a:["Nairobi","Westlands","Kilimani"],w:3,sp:["laptop","s","t","b"],rt:"2-4h"},
    {id:2,n:"GreenCycle EA",r:4.6,d:5.1,p:{laptop:140,s:70,t:110,m:180,pr:160,tv:220,b:45,o:90},a:["Mombasa","Nyali"],w:1,sp:["m","pr","tv"],rt:"4-6h"},
    {id:3,n:"Circuit Reclaim",r:4.9,d:3.7,p:{laptop:160,s:90,t:130,m:220,pr:200,tv:280,b:55,o:120},a:["Kisumu"],w:2,sp:["laptop","m","tv"],rt:"1-3h"},
    {id:4,n:"Battery & Beyond",r:4.7,d:1.8,p:{laptop:130,s:60,t:100,m:190,pr:170,tv:240,b:40,o:80},a:["Nairobi","Eastlands"],w:5,sp:["s","t","b","o"],rt:"3-5h"},
    {id:5,n:"Eldoret Recyclers",r:4.5,d:4.2,p:{laptop:135,s:65,t:105,m:185,pr:165,tv:230,b:42,o:85},a:["Eldoret"],w:2,sp:["laptop","s","m"],rt:"3-5h"}
];

const D = [
    {v:"laptop",l:"üíª Laptop",pr:150},{v:"s",l:"üì± Phone",pr:80},{v:"t",l:"üìü Tablet",pr:120},
    {v:"m",l:"üñ•Ô∏è Monitor",pr:200},{v:"pr",l:"üñ®Ô∏è Printer",pr:180},{v:"tv",l:"üì∫ TV",pr:250},
    {v:"b",l:"üîã Battery",pr:50},{v:"o",l:"üîß Other",pr:100}
];

let loc = "Nairobi";

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    const d = document.getElementById('pickupDate');
    d.min = d.value = new Date().toISOString().split('T')[0];
    document.getElementById('pickupForm').addEventListener('submit', h);
    document.getElementById('addDeviceBtn').addEventListener('click', addRow);
    document.getElementById('location').addEventListener('input', e => loc = e.target.value || 'Nairobi');
    addRow();
});

const opt = (s='') => '<option value="">Select</option>' + D.map(d => `<option value="${d.v}" ${d.v===s?'selected':''}>${d.l} - KSh ${d.pr}</option>`).join('');

function addRow() {
    const c = document.getElementById('devicesContainer'), row = document.createElement('div');
    row.className = 'device-row';
    row.innerHTML = `<select class="dt" required>${opt()}</select><input type="number" class="dq" min="1" value="1" required><button type="button" class="remove-device" ${c.children.length===0?'':'x'}>√ó</button>`;
    
    row.querySelector('.dt').addEventListener('change', upd);
    row.querySelector('.dq').addEventListener('input', upd);
    c.children.length > 0 && row.querySelector('.remove-device').addEventListener('click', () => {row.remove(); upd(); updBtn();});
    
    c.appendChild(row);
    updBtn(); upd();
}

function updBtn() {
    const c = document.getElementById('devicesContainer'), b = c.querySelectorAll('.remove-device');
    b.forEach((btn,i) => btn.disabled = i===0 && c.children.length===1);
    document.getElementById('deviceCountText').textContent = c.children.length + (c.children.length===1?' device':' devices');
}

function upd() {
    let t = 0;
    document.querySelectorAll('.device-row').forEach(r => {
        const s = r.querySelector('.dt'), q = r.querySelector('.dq');
        if(s.value && q.value) t += (D.find(d => d.v === s.value)?.pr||0) * parseInt(q.value);
    });
    document.getElementById('totalAmount').textContent = `KSh ${t}`;
}

function getD() {
    const dev = [];
    document.querySelectorAll('.device-row').forEach(r => {
        const s = r.querySelector('.dt'), q = r.querySelector('.dq');
        if(s.value && q.value) dev.push({t:s.v,l:D.find(d=>d.v===s.value)?.l||'',q:parseInt(q.value),pr:D.find(d=>d.v===s.value)?.pr||0});
    });
    return dev;
}

function findR(dev) {
    const types = [...new Set(dev.map(d => d.t))], eligible = R.filter(r => types.some(t => r.sp.includes(t)||r.sp.includes('o')));
    if(!eligible.length) return null;
    
    return eligible.map(r => ({
        ...r, score: Math.max(0,40-r.d*2) + (r.a.some(a => loc.toLowerCase().includes(a.toLowerCase())||a.toLowerCase().includes(loc.toLowerCase()))?40:10) + Math.max(0,20-r.w*3) + (types.filter(t=>r.sp.includes(t)).length/types.length)*20 + (r.r-4)*5,
        total: dev.reduce((s,d)=> s + (r.p[d.t]||r.p.o)*d.q, 0)
    })).sort((a,b)=>b.score-a.score)[0];
}

function h(e) {
    e.preventDefault();
    const dev = getD();
    if(!dev.length) return alert('Add at least one device');
    
    loc = document.getElementById('location').value || 'Nairobi';
    document.getElementById('btnText').classList.add('hidden');
    document.getElementById('btnLoading').classList.remove('hidden');
    document.getElementById('submitBtn').disabled = !0;
    
    setTimeout(() => {
        const r = findR(dev);
        document.getElementById('btnText').classList.remove('hidden');
        document.getElementById('btnLoading').classList.add('hidden');
        document.getElementById('submitBtn').disabled = !1;
        
        if(r) {
            document.getElementById('assignedRecycler').innerHTML = `
                <div class="recycler-header"><span class="recycler-name">üè≠ ${r.n}</span><span class="recycler-badge">‚≠ê ${r.r}</span></div>
                <p style="color:#4b5563;margin-bottom:15px;">‚úì Serving: ${loc}</p>
                <div style="margin-bottom:15px;padding:10px;background:var(--bg);border-radius:8px;"><strong>üì¶ Devices:</strong> ${dev.map(d=>`${d.l} x${d.q}`).join(', ')}</div>
                <div class="recycler-details">
                    <div class="detail-item"><div class="detail-label">Distance</div><div class="detail-value">${r.d} km</div></div>
                    <div class="detail-item"><div class="detail-label">Response</div><div class="detail-value">${r.rt}</div></div>
                    <div class="detail-item"><div class="detail-label">Total</div><div class="detail-value">KSh ${r.total}</div></div>
                </div>
                <div style="margin-top:15px;padding-top:15px;border-top:1px solid #e5e7eb;"><p style="font-size:0.9em;color:#059669;"><strong>üèÜ Best match</strong></p></div>`;
            
            sessionStorage.setItem('p', JSON.stringify({r,dev,total:r.total,loc,date:document.getElementById('pickupDate').value,time:document.getElementById('pickupTime').value,notes:document.getElementById('notes').value}));
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
        } else alert('No recycler available');
    }, 1500);
}

function confirmPickup() {
    const p = JSON.parse(sessionStorage.getItem('p'));
    document.getElementById('confirmationNumber').innerHTML = `üìã #DME-${new Date().getFullYear()}-${Math.floor(Math.random()*1e4).toString().padStart(4,'0')}`;
    document.getElementById('confirmedDevices').innerHTML = `<strong>Devices:</strong> ${p.dev.map(d=>`${d.l} x${d.q}`).join(' ‚Ä¢ ')}<br><strong>Total:</strong> KSh ${p.total}`;
    document.getElementById('step2').classList.add('hidden');
    document.getElementById('step3').classList.remove('hidden');
}

function resetForm() { document.getElementById('step2').classList.add('hidden'); document.getElementById('step1').classList.remove('hidden'); }

function scheduleAnother() {
    document.getElementById('step3').classList.add('hidden');
    document.getElementById('step1').classList.remove('hidden');
    sessionStorage.removeItem('p');
    document.getElementById('pickupForm').reset();
    document.getElementById('pickupDate').value = new Date().toISOString().split('T')[0];
    document.getElementById('location').value = 'Nairobi';
    loc = 'Nairobi';
    document.getElementById('devicesContainer').innerHTML = '';
    addRow();
}
</script>
</body>
</html>