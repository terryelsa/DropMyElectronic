<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recycling Centers - DropMyElectronic</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        :root {
            --primary-color: #2e7d32; --primary-light: #4caf50; --primary-dark: #1b5e20;
            --secondary-color: #ff9800; --accent-color: #2196f3; --text-color: #333;
            --light-bg: #f5f5f5; --white: #ffffff; --card-bg: #ffffff;
            --shadow: 0 4px 6px rgba(0,0,0,0.1); --radius: 8px; --footer-bg: #1a1a1a;
            --footer-text: #ffffff; --hero-gradient: linear-gradient(135deg, var(--primary-light) 0%, var(--primary-color) 100%);
            --header-bg: #ffffff;
        }
        .dark-mode {
            --primary-color: #4caf50; --primary-light: #66bb6a; --primary-dark: #388e3c;
            --secondary-color: #ffb74d; --accent-color: #64b5f6; --text-color: #e0e0e0;
            --light-bg: #121212; --white: #1e1e1e; --card-bg: #2d2d2d;
            --shadow: 0 4px 6px rgba(0,0,0,0.3); --footer-bg: #0a0a0a; --footer-text: #e0e0e0;
            --hero-gradient: linear-gradient(135deg, #1b5e20 0%, #2e7d32 100%); --header-bg: #1e1e1e;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease; }
        body { font-family: 'Segoe UI', sans-serif; line-height: 1.6; color: var(--text-color); background-color: var(--light-bg); }
        a { text-decoration: none; color: inherit; }
        .container { width: 90%; max-width: 1200px; margin: 0 auto; padding: 0 15px; }
        .btn { display: inline-block; background-color: var(--primary-color); color: white; padding: 8px 16px; border-radius: 4px; font-weight: 600; transition: all 0.3s ease; border: none; cursor: pointer; text-align: center; font-size: 0.9rem; }
        .btn:hover { background-color: var(--primary-dark); transform: translateY(-2px); }
        .btn-secondary { background-color: var(--secondary-color); }
        .btn-secondary:hover { background-color: #e68900; }
        section { padding: 60px 0; }
        h1, h2, h3, h4 { margin-bottom: 1rem; line-height: 1.2; }
        header { background-color: var(--header-bg); box-shadow: var(--shadow); position: sticky; top: 0; z-index: 100; }
        .header-container { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; }
        .logo { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); }
        .nav-links { display: flex; align-items: center; list-style: none; gap: 25px; margin-left: auto; margin-right: 25px; }
        .nav-links a { font-weight: 500; transition: color 0.3s ease; }
        .nav-links a:hover, .nav-links .active { color: var(--primary-color); font-weight: 600; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .dark-mode-toggle { display: flex; align-items: center; gap: 8px; background-color: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 6px 12px; border-radius: 30px; box-shadow: var(--shadow); }
        .dark-mode-label { display: flex; align-items: center; gap: 6px; cursor: pointer; font-weight: 500; color: var(--text-color); font-size: 0.85rem; }
        .dark-mode-switch { position: relative; width: 34px; height: 18px; background-color: #ccc; border-radius: 34px; transition: background-color 0.3s; }
        .dark-mode-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; background-color: white; border-radius: 50%; transition: transform 0.3s; }
        #dark-mode-checkbox:checked + .dark-mode-switch { background-color: var(--primary-color); }
        #dark-mode-checkbox:checked + .dark-mode-switch::after { transform: translateX(16px); }
        #dark-mode-checkbox { display: none; }
        .hero { background: var(--hero-gradient); color: white; text-align: center; padding: 15px 0; }
        .hero h1 { font-size: 2.5rem; margin-bottom: 1.5rem; }
        .hero p { font-size: 1.2rem; max-width: 700px; margin: 0 auto 2rem; }
        .map-section { padding: 40px 0; }
        .map-container { display: grid; grid-template-columns: 1fr 2fr; gap: 30px; height: 600px; }
        .sidebar { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 25px; display: flex; flex-direction: column; overflow-y: auto; }
        .search-box { margin-bottom: 25px; }
        .search-box input { width: 100%; padding: 12px 15px; border: 1px solid var(--text-color); border-radius: 4px; font-size: 1rem; margin-bottom: 15px; background-color: var(--white); color: var(--text-color); }
        .search-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        .search-actions .btn { flex: 1; min-width: 120px; padding: 12px 24px; }
        .results-info { margin: 10px 0; padding: 10px; background-color: var(--light-bg); border-radius: var(--radius); font-size: 0.9rem; }
        .sidebar h3 { color: var(--primary-dark); margin-bottom: 20px; font-size: 1.4rem; }
        .centers-list { flex-grow: 1; overflow-y: auto; }
        .center-card { background-color: var(--white); border-radius: var(--radius); padding: 20px; margin-bottom: 15px; cursor: pointer; transition: all 0.3s ease; border-left: 4px solid transparent; }
        .center-card:hover, .center-card.active { transform: translateY(-3px); box-shadow: var(--shadow); border-left-color: var(--primary-color); }
        .center-card.active { background-color: var(--light-bg); }
        .center-card h4 { color: var(--primary-dark); margin-bottom: 10px; font-size: 1.2rem; }
        .contact-details p { margin-bottom: 8px; display: flex; align-items: flex-start; gap: 8px; }
        .contact-details strong { min-width: 20px; }
        .distance-badge { display: inline-block; background-color: var(--primary-light); color: white; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; margin-top: 5px; }
        .map-wrapper { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; height: 100%; }
        #map { height: 100%; width: 100%; }
        .dark-mode .leaflet-layer,
        .dark-mode .leaflet-control-zoom-in,
        .dark-mode .leaflet-control-zoom-out,
        .dark-mode .leaflet-control-attribution { filter: brightness(0.6) invert(1) hue-rotate(180deg) contrast(3); }
        .recycler-marker, .user-marker, .search-marker { background: transparent; border: none; font-size: 24px; text-align: center; }
        .user-marker { filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5)); }
        .leaflet-popup-content { font-family: 'Segoe UI', sans-serif; }
        .leaflet-popup-content-wrapper { border-radius: var(--radius); box-shadow: var(--shadow); background-color: var(--card-bg); color: var(--text-color); }
        .leaflet-popup-tip { background-color: var(--card-bg); }
        .leaflet-container a.leaflet-popup-close-button { color: var(--text-color); }
        .leaflet-container a.leaflet-popup-close-button:hover { color: var(--primary-color); }
        .info-section { background-color: var(--white); }
        .section-title { text-align: center; margin-bottom: 3rem; }
        .section-title h2 { font-size: 2.2rem; color: var(--primary-dark); }
        .section-title p { color: var(--text-color); max-width: 600px; margin: 0 auto; }
        .info-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 25px; }
        .info-card { background-color: var(--card-bg); border-radius: var(--radius); box-shadow: var(--shadow); padding: 30px; text-align: center; transition: transform 0.3s ease; }
        .info-card:hover { transform: translateY(-5px); }
        .info-icon { font-size: 3rem; color: var(--primary-color); margin-bottom: 20px; }
        .info-card h3 { color: var(--primary-dark); margin-bottom: 15px; }
        footer { background-color: var(--footer-bg); color: var(--footer-text); padding: 50px 0 20px; }
        .footer-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 30px; margin-bottom: 30px; }
        .footer-column h3 { font-size: 1.2rem; margin-bottom: 1.5rem; color: var(--primary-light); }
        .footer-links { list-style: none; }
        .footer-links li { margin-bottom: 10px; }
        .footer-links a { transition: color 0.3s ease; }
        .footer-links a:hover { color: var(--primary-light); }
        .copyright { text-align: center; padding-top: 20px; border-top: 1px solid #333; font-size: 0.9rem; color: #aaa; }
        @media (max-width: 1024px) { .nav-links { gap: 20px; margin-right: 20px; } .header-right { gap: 12px; } }
        @media (max-width: 768px) {
            .header-container { flex-direction: column; gap: 15px; }
            .nav-links { margin: 10px auto; gap: 15px; flex-wrap: wrap; justify-content: center; margin-right: 0; }
            .header-right { order: 1; width: 100%; justify-content: center; margin-top: 10px; }
            .hero h1 { font-size: 2rem; }
            .map-container { grid-template-columns: 1fr; height: auto; }
            .map-wrapper { height: 400px; }
            .search-actions { flex-direction: column; }
            .search-actions .btn { width: 100%; }
            .dark-mode-toggle { padding: 6px 12px; }
            .dark-mode-label span { display: none; }
        }
        @media (max-width: 480px) { .hero h1 { font-size: 1.8rem; } .section-title h2 { font-size: 1.8rem; } }
    </style>
</head>
<body>
    <header><div class="container header-container">
        <a href="index.html" class="logo">DropMyElectronic</a>
        <ul class="nav-links">
            <li><a href="index.html">Home</a></li><li><a href="about.html">About</a></li>
            <li><a href="reward.html">Rewards</a></li><li><a href="quiz.html">Quiz</a></li>
            <li><a href="support.html">Support</a></li>
        </ul>
        <div class="header-right">
            <a href="sign.html" class="btn">Start now</a>
            <div class="dark-mode-toggle">
                <label for="dark-mode-checkbox" class="dark-mode-label">
                    <i class="fas fa-moon"></i><span>Dark Mode</span>
                    <input type="checkbox" id="dark-mode-checkbox"><div class="dark-mode-switch"></div>
                </label>
            </div>
        </div>
    </div></header>
    <section class="hero"><div class="container">
        <h1>Nairobi Recycling Centers</h1>
        <p>Find certified e-waste recycling facilities near you. Locate drop-off points and learn about proper disposal methods.</p>
    </div></section>
    <section class="map-section"><div class="container">
        <div class="map-container">
            <div class="sidebar">
                <div class="search-box">
                    <input type="text" id="locationSearch" placeholder="Search any location in Nairobi...">
                    <div class="search-actions">
                        <button class="btn" onclick="searchLocation()">Search Area</button>
                        <button class="btn btn-secondary" onclick="useCurrentLocation()">My Location</button>
                    </div>
                    <div class="results-info" id="resultsInfo"></div>
                </div>
                <h3><i class="fas fa-map-marker-alt"></i> Recycling Centers</h3>
                <div class="centers-list" id="centerList"></div>
            </div>
            <div class="map-wrapper"><div id="map"></div></div>
        </div>
    </div></section>
    <section class="info-section"><div class="container">
        <div class="section-title">
            <h2>How to Use Our Map</h2>
            <p>Find the best recycling options for your e-waste</p>
        </div>
        <div class="info-grid">
            <div class="info-card"><div class="info-icon"><i class="fas fa-search-location"></i></div><h3>Search Locations</h3><p>Use the search box to find recycling centers in specific Nairobi areas or use your current location.</p></div>
            <div class="info-card"><div class="info-icon"><i class="fas fa-info-circle"></i></div><h3>View Details</h3><p>Click on any recycling center to see operating hours, accepted items, and contact information.</p></div>
            <div class="info-card"><div class="info-icon"><i class="fas fa-route"></i></div><h3>Plan Your Visit</h3><p>Check the center details to ensure they accept your specific e-waste items before visiting.</p></div>
        </div>
    </div></section>
    <footer><div class="container">
        <div class="footer-content">
            <div class="footer-column"><h3>DropMyElectronic</h3><p>Making e-waste recycling simple and accessible for everyone.</p></div>
            <div class="footer-column"><h3>Quick Links</h3><ul class="footer-links">
                <li><a href="index.html">Home</a></li><li><a href="about.html">About</a></li>
                <li><a href="reward.html">Rewards</a></li><li><a href="support.html">Support</a></li>
            </ul></div>
            <div class="footer-column"><h3>Resources</h3><ul class="footer-links">
                <li><a href="#">FAQ</a></li><li><a href="#">Support</a></li>
            </ul></div>
            <div class="footer-column"><h3>Contact</h3><ul class="footer-links">
                <li><a href="mailto:info@dropmyelectronic.com">Email</a></li><li><a href="#">Twitter</a></li>
            </ul></div>
        </div>
        <div class="copyright">
            <p>&copy; 2023 DropMyElectronic. All rights reserved. | Made with ❤️ for a sustainable future</p>
        </div>
    </div></footer>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const centers = [
            {id:1,name:"WEEE Centre - Nairobi",lat:-1.278398296907602,lng:36.952653695036254,address:"Mihango, Embakasi, Off the Eastern By-pass",phone:"0701819559",hours:"Mon-Fri: 8AM-5PM\nSat: 9AM-1PM\nSun: Closed",accepts:"Computers, phones, TVs, printers, batteries"},
            {id:2,name:"Safaricom E-Waste Drop-off",lat:-1.2733,lng:36.8067,address:"Safaricom House, Westlands, Nairobi",phone:"0722000000",hours:"Mon-Fri: 8AM-5PM",accepts:"Mobile phones, tablets, accessories, batteries"},
            {id:3,name:"Eco Create & Innovate - ECANDI",lat:-1.2156578760311965,lng:36.797297222022095,address:"32824, Limuru Rd, Nairobi",phone:"0741777986",hours:"Mon-Fri: 9AM-6PM \n Sat: 9AM-4PM \n Sun: Closed",accepts:"All electronics, appliances, batteries"},
            {id:4,name:"GreenTech Solutions",lat:-1.2762636825707399,lng:36.8267353691281,address:"Next to Nyayo Market, Ngara, Nairobi.",phone:"0722969219",hours:"Mon-Sat: 9AM-5PM\nSun: Closed",accepts:"Phones, laptops, small electronics"}
        ];
        
        const popularAreas = {
            'cbd':[-1.286389,36.817223],'westlands':[-1.2659,36.8067],'kilimani':[-1.2950,36.7860],
            'karen':[-1.3159,36.8342],'industrial area':[-1.3083,36.8469],'lavington':[-1.2684,36.7749],
            'parklands':[-1.2597,36.8186],'embakasi':[-1.3076,36.9182],'kasarani':[-1.2186,36.8925],
            'runda':[-1.2056,36.8281],'ngong road':[-1.3000,36.7800],'thika road':[-1.2300,36.8700],
            'south b':[-1.3100,36.8300],'south c':[-1.3200,36.8300],'eastleigh':[-1.2750,36.8500],
            'donholm':[-1.2750,36.8900],'buruburu':[-1.2800,36.8750],'uthiru':[-1.2500,36.7600],
            'kawangware':[-1.2650,36.7550],'dagoretti':[-1.2900,36.7200]
        };
        
        let map, userMarker, searchMarker, markers = [], activeCenterId = null, currentSearchLocation = null;

        function initMap() {
            map = L.map('map').setView([-1.286389, 36.817223], 11);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(map);
            
            centers.forEach(center => {
                const icon = L.divIcon({
                    html: '<i class="fas fa-recycle" style="color: #2e7d32; font-size: 24px;"></i>',
                    className: 'recycler-marker',
                    iconSize: [30, 30],
                    iconAnchor: [15, 30]
                });
                const marker = L.marker([center.lat, center.lng], { icon }).addTo(map).bindPopup(`<div style="text-align: left; min-width: 250px; font-family: 'Segoe UI', sans-serif;">
                    <h4 style="margin: 0 0 10px 0; color: #1b5e20;">${center.name}</h4>
                    <p style="margin: 5px 0;"><strong><i class="fas fa-phone"></i> Phone:</strong> ${center.phone}</p>
                    <p style="margin: 5px 0;"><strong><i class="fas fa-map-marker-alt"></i> Address:</strong> ${center.address}</p>
                    <p style="margin: 5px 0;"><strong><i class="fas fa-clock"></i> Hours:</strong> ${center.hours}</p>
                    <p style="margin: 5px 0;"><strong><i class="fas fa-check-circle"></i> Accepts:</strong> ${center.accepts}</p>
                    <button onclick="focusOnCenter(${center.id})" style="width: 100%; padding: 10px; margin-top: 10px; background: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">View Details</button></div>`);
                marker.on('click', () => setActiveCenter(center.id));
                markers.push({marker, centerId: center.id});
            });
            
            const nairobiBoundary = [[-1.510, 36.650],[-1.510, 37.050],[-1.050, 37.050],[-1.050, 36.650],[-1.510, 36.650]];
            L.polygon(nairobiBoundary, {
                color: '#4caf50',
                weight: 2,
                opacity: 0.3,
                fillColor: '#4caf50',
                fillOpacity: 0.05
            }).addTo(map).bindPopup('Nairobi County Area');
            
            updateCenterList();
            
            document.getElementById('locationSearch').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') searchLocation();
            });
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                    Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function updateCenterList(filteredCenters = null, searchLocation = null) {
            const centerList = document.getElementById('centerList');
            const resultsInfo = document.getElementById('resultsInfo');
            
            let centersToShow = filteredCenters || centers;
            
            if (searchLocation && centersToShow.length > 0) {
                // Sort centers by distance from search location
                centersToShow = centersToShow.map(center => {
                    const distance = calculateDistance(
                        searchLocation.lat, searchLocation.lng,
                        center.lat, center.lng
                    );
                    return { ...center, distance: distance };
                }).sort((a, b) => a.distance - b.distance);
                
                // Show results info
                resultsInfo.innerHTML = `<strong>${centersToShow.length} recycling center${centersToShow.length !== 1 ? 's' : ''} found near your search</strong>`;
                resultsInfo.style.display = 'block';
            } else if (searchLocation && centersToShow.length === 0) {
                resultsInfo.innerHTML = `<strong>No recycling centers found near your search. Showing all centers.</strong>`;
                resultsInfo.style.display = 'block';
                centersToShow = centers;
            } else {
                resultsInfo.style.display = 'none';
            }
            
            centerList.innerHTML = centersToShow.map((center,i) => {
                const distanceText = center.distance ? 
                    `<div class="distance-badge">${center.distance.toFixed(1)} km away</div>` : '';
                return `<div class="center-card" style="animation-delay:${i*0.1}s" onclick="focusOnCenter(${center.id});setActiveCenter(${center.id})">
                    <h4>${center.name}</h4>${distanceText}<div class="contact-details">
                    <p><strong><i class="fas fa-map-marker-alt"></i></strong> ${center.address}</p>
                    <p><strong><i class="fas fa-phone"></i></strong> ${center.phone}</p>
                    <p><strong><i class="fas fa-clock"></i></strong> ${center.hours}</p>
                    <p><strong><i class="fas fa-check-circle"></i></strong> ${center.accepts}</p></div></div>`;
            }).join('');
        }

        function setActiveCenter(centerId) {
            document.querySelectorAll('.center-card').forEach(card => card.classList.remove('active'));
            const card = document.querySelector(`.center-card[onclick*="${centerId}"]`);
            if (card) { 
                card.classList.add('active'); 
                card.scrollIntoView({behavior:'smooth',block:'nearest'}); 
            }
            activeCenterId = centerId;
        }

        function focusOnCenter(centerId) {
            const center = centers.find(c => c.id === centerId);
            if (center) {
                map.setView([center.lat, center.lng], 15);
                markers.find(m => m.centerId === centerId).marker.openPopup();
            }
        }

        function findNearbyCenters(searchLat, searchLng, radiusKm = 10) {
            return centers.filter(center => {
                const distance = calculateDistance(searchLat, searchLng, center.lat, center.lng);
                return distance <= radiusKm;
            });
        }

        function searchLocation() {
            const searchInput = document.getElementById('locationSearch');
            const searchTerm = searchInput.value.trim();
            
            if (!searchTerm) { 
                alert('Please enter a location to search.'); 
                return; 
            }
            
            const areaKey = searchTerm.toLowerCase();
            let searchLat, searchLng, locationName;
            
            // Check popular areas first
            if (popularAreas[areaKey]) {
                searchLat = popularAreas[areaKey][0];
                searchLng = popularAreas[areaKey][1];
                locationName = searchTerm;
                handleSearchResult(searchLat, searchLng, locationName, searchTerm);
                return;
            }
            
            // Use OpenStreetMap API for other locations
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchTerm + ', Nairobi, Kenya')}&limit=1`;
            
            const btn = event?.target || document.querySelector('.btn[onclick="searchLocation()"]');
            const originalText = btn.textContent;
            btn.textContent = 'Searching...';
            btn.disabled = true;
            
            fetch(url)
                .then(response => response.json())
                .then(data => {
                    if (data && data.length > 0) {
                        searchLat = parseFloat(data[0].lat);
                        searchLng = parseFloat(data[0].lon);
                        locationName = data[0].display_name;
                        
                        const isInNairobi = searchLat >= -1.55 && searchLat <= -1.05 && searchLng >= 36.65 && searchLng <= 37.05;
                        
                        if (isInNairobi) {
                            handleSearchResult(searchLat, searchLng, locationName, searchTerm);
                        } else {
                            alert('The location found appears to be outside Nairobi. Please try a more specific Nairobi location.');
                            map.setView([-1.286389, 36.817223], 11);
                            updateCenterList(); // Reset to show all centers
                        }
                    } else {
                        alert('Location not found. Please try a different search term.');
                        map.setView([-1.286389, 36.817223], 11);
                        updateCenterList(); // Reset to show all centers
                    }
                })
                .catch(error => {
                    console.error('Error searching location:', error);
                    alert('Error searching location. Please check your connection and try again.');
                    map.setView([-1.286389, 36.817223], 11);
                })
                .finally(() => {
                    btn.textContent = originalText;
                    btn.disabled = false;
                });
        }

        function handleSearchResult(searchLat, searchLng, locationName, searchTerm) {
            currentSearchLocation = { lat: searchLat, lng: searchLng };
            
            // Move map to searched location
            map.setView([searchLat, searchLng], 14);
            
            // Add search marker
            addSearchMarker(searchLat, searchLng, locationName);
            
            // Find nearby recycling centers (within 10km)
            const nearbyCenters = findNearbyCenters(searchLat, searchLng, 10);
            
            // Update the list to show only nearby centers
            updateCenterList(nearbyCenters, currentSearchLocation);
            
            // Clear search input
            document.getElementById('locationSearch').value = '';
            
            // Highlight nearby centers on the map
            highlightNearbyCenters(nearbyCenters);
        }

        function addSearchMarker(lat, lng, name) {
            if (searchMarker) {
                map.removeLayer(searchMarker);
            }
            
            const searchIcon = L.divIcon({
                html: '<i class="fas fa-search-location" style="color: #2196f3; font-size: 24px;"></i>',
                className: 'search-marker',
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });
            
            searchMarker = L.marker([lat, lng], { icon: searchIcon })
                .addTo(map)
                .bindPopup(`<b>${name}</b><br>Searched location`)
                .openPopup();
        }

        function highlightNearbyCenters(nearbyCenters) {
            // Reset all markers to default color
            markers.forEach(markerObj => {
                const marker = markerObj.marker;
                const icon = marker.getIcon();
                icon.options.html = '<i class="fas fa-recycle" style="color: #2e7d32; font-size: 24px;"></i>';
                marker.setIcon(icon);
            });
            
            // Highlight nearby centers
            nearbyCenters.forEach(center => {
                const markerObj = markers.find(m => m.centerId === center.id);
                if (markerObj) {
                    const marker = markerObj.marker;
                    const icon = marker.getIcon();
                    icon.options.html = '<i class="fas fa-recycle" style="color: #ff9800; font-size: 28px;"></i>';
                    marker.setIcon(icon);
                }
            });
        }

        function useCurrentLocation() {
            if (!navigator.geolocation) { 
                alert('Geolocation not supported by your browser.'); 
                return; 
            }
            const btn = event.target, originalText = btn.textContent;
            btn.textContent = 'Locating...'; 
            btn.disabled = true;
            navigator.geolocation.getCurrentPosition(
                position => {
                    const lat = position.coords.latitude, lng = position.coords.longitude;
                    const isInNairobi = lat >= -1.55 && lat <= -1.05 && lng >= 36.65 && lng <= 37.05;
                    if (isInNairobi) {
                        currentSearchLocation = { lat: lat, lng: lng };
                        map.setView([lat, lng], 14);
                        
                        const userIcon = L.divIcon({
                            html: '<i class="fas fa-user" style="color: #ff9800; font-size: 24px;"></i>',
                            className: 'user-marker',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        });
                        if (userMarker) {
                            userMarker.setLatLng([lat, lng]);
                        } else {
                            userMarker = L.marker([lat, lng], { icon: userIcon })
                                .addTo(map)
                                .bindPopup('Your Current Location')
                                .openPopup();
                        }
                        
                        // Find nearby recycling centers
                        const nearbyCenters = findNearbyCenters(lat, lng, 10);
                        updateCenterList(nearbyCenters, currentSearchLocation);
                        highlightNearbyCenters(nearbyCenters);
                        
                        btn.textContent = 'Location Found!';
                    } else {
                        alert('You appear to be outside Nairobi. Centering on Nairobi CBD.');
                        map.setView([-1.286389, 36.817223], 11);
                        updateCenterList(); // Reset to show all centers
                        btn.textContent = originalText;
                    }
                    setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);
                },
                () => {
                    alert('Unable to get location. Please enable location services or search manually.');
                    btn.textContent = originalText; 
                    btn.disabled = false;
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 60000 }
            );
        }

        document.addEventListener('DOMContentLoaded', initMap);
        const darkModeToggle = document.getElementById('dark-mode-checkbox');
        const body = document.body;
        const prefersDarkScheme = window.matchMedia('(prefers-color-scheme: dark)');
        const currentTheme = localStorage.getItem('theme');
        
        function updateDarkModeIcon(isDark) {
            const icon = document.querySelector('.dark-mode-label i');
            const label = document.querySelector('.dark-mode-label span');
            icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            label.textContent = isDark ? 'Light Mode' : 'Dark Mode';
        }
        
        if (currentTheme === 'dark' || (!currentTheme && prefersDarkScheme.matches)) {
            body.classList.add('dark-mode');
            darkModeToggle.checked = true;
            updateDarkModeIcon(true);
        }
        
        darkModeToggle.addEventListener('change', function() {
            if (this.checked) {
                body.classList.add('dark-mode');
                localStorage.setItem('theme', 'dark');
                updateDarkModeIcon(true);
            } else {
                body.classList.remove('dark-mode');
                localStorage.setItem('theme', 'light');
                updateDarkModeIcon(false);
            }
        });
        
        prefersDarkScheme.addEventListener('change', function(e) {
            if (!localStorage.getItem('theme')) {
                if (e.matches) {
                    body.classList.add('dark-mode');
                    darkModeToggle.checked = true;
                    updateDarkModeIcon(true);
                } else {
                    body.classList.remove('dark-mode');
                    darkModeToggle.checked = false;
                    updateDarkModeIcon(false);
                }
            }
        });
    </script>
</body>
</html>